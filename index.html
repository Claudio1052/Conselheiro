<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Vidas & Escalas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
        .nav-link { color: rgba(255,255,255,0.8); cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .card-counter { box-shadow: 2px 2px 10px #DADADA; margin: 5px; padding: 20px 10px; background-color: #fff; height: 100px; border-radius: 5px; transition: .3s linear all; }
        .card-counter:hover { box-shadow: 4px 4px 20px #DADADA; transform: scale(1.02); }
        .card-counter i { font-size: 5em; opacity: 0.2; position: absolute; right: 10px; top: 10px; }
        .bg-primary-light { background-color: #e3f2fd; }
        .hidden { display: none; }
        /* Cores específicas para decisões */
        .border-jesus { border-left: 5px solid #007bff; }
        .border-nascimento { border-left: 5px solid #28a745; }
        .border-batismo { border-left: 5px solid #ffc107; }
        .border-volta { border-left: 5px solid #dc3545; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
            <h4 class="text-center mb-4"><i class="bi bi-church"></i> Gestão Vidas</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showSection('pessoas')"><i class="bi bi-people"></i> Pessoas / Decisões</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showSection('escalas')"><i class="bi bi-calendar-week"></i> Escalas de Culto</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showSection('conselheiros')"><i class="bi bi-person-badge"></i> Conselheiros</a></li>
            </ul>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            
            <div class="d-md-none mb-3">
                <button class="btn btn-dark w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
                    <i class="bi bi-list"></i> Menu
                </button>
                <div class="collapse mt-2" id="mobileMenu">
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" onclick="showSection('dashboard')">Dashboard</a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showSection('pessoas')">Pessoas</a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showSection('escalas')">Escalas</a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showSection('conselheiros')">Conselheiros</a>
                    </div>
                </div>
            </div>

            <div id="dashboard" class="section">
                <h2 class="mb-4">Visão Geral do Reino</h2>
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="card-counter border-jesus">
                            <i class="bi bi-heart-fill"></i>
                            <span class="count-numbers" id="count-jesus">0</span>
                            <span class="count-name d-block">Aceitaram Jesus</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-counter border-nascimento">
                            <i class="bi bi-droplet-fill"></i>
                            <span class="count-numbers" id="count-nascimento">0</span>
                            <span class="count-name d-block">Novo Nascimento</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-counter border-batismo">
                            <i class="bi bi-fire"></i>
                            <span class="count-numbers" id="count-batismo">0</span>
                            <span class="count-name d-block">Batismo Esp. Santo</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-counter border-volta">
                            <i class="bi bi-arrow-return-left"></i>
                            <span class="count-numbers" id="count-volta">0</span>
                            <span class="count-name d-block">Volta p/ Jesus</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>Distribuição de Decisões</h5>
                            <canvas id="decisoesChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>Últimos Cadastros</h5>
                            <ul class="list-group list-group-flush" id="recent-list">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pessoas" class="section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Cadastro de Pessoas</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPessoa" onclick="carregarSelectConselheiros()">
                        <i class="bi bi-plus-circle"></i> Nova Pessoa
                    </button>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" id="filtro-nome" class="form-control" placeholder="Buscar por nome..." onkeyup="filtrarPessoas()">
                            </div>
                            <div class="col-md-3">
                                <select id="filtro-decisao" class="form-select" onchange="filtrarPessoas()">
                                    <option value="">Todas as Decisões</option>
                                    <option value="Aceitou Jesus">Aceitou Jesus</option>
                                    <option value="Novo Nascimento">Novo Nascimento</option>
                                    <option value="Batismo Espírito Santo">Batismo Espírito Santo</option>
                                    <option value="Volta para Jesus">Volta para Jesus</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive bg-white rounded shadow-sm">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Endereço</th>
                                <th>Decisão</th>
                                <th>Conselheiro Resp.</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-pessoas">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="escalas" class="section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Escalas de Culto</h2>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalEscala" onclick="carregarSelectConselheirosEscala()">
                        <i class="bi bi-calendar-plus"></i> Nova Escala
                    </button>
                </div>

                <div class="row" id="container-escalas">
                    </div>
            </div>

            <div id="conselheiros" class="section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Conselheiros</h2>
                    <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#modalConselheiro">
                        <i class="bi bi-person-plus"></i> Novo Conselheiro
                    </button>
                </div>
                <ul class="list-group" id="lista-conselheiros">
                    </ul>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalPessoa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Decisão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formPessoa">
                    <div class="mb-3">
                        <label>Nome Completo</label>
                        <input type="text" class="form-control" id="p_nome" required>
                    </div>
                    <div class="mb-3">
                        <label>Telefone / WhatsApp</label>
                        <input type="text" class="form-control" id="p_telefone" placeholder="(XX) 9XXXX-XXXX">
                    </div>
                    <div class="mb-3">
                        <label>Endereço</label>
                        <input type="text" class="form-control" id="p_endereco">
                    </div>
                    <div class="mb-3">
                        <label>Decisão</label>
                        <select class="form-select" id="p_decisao" required>
                            <option value="Aceitou Jesus">Aceitou Jesus</option>
                            <option value="Volta para Jesus">Volta para Jesus</option>
                            <option value="Novo Nascimento">Novo Nascimento</option>
                            <option value="Batismo Espírito Santo">Batismo Espírito Santo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Conselheiro Responsável</label>
                        <select class="form-select" id="p_conselheiro">
                            <option value="">Selecione...</option>
                            </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Salvar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEscala" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agendar Escala</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEscala">
                    <div class="mb-3">
                        <label>Conselheiro</label>
                        <select class="form-select" id="e_conselheiro" required>
                            </select>
                    </div>
                    <div class="mb-3">
                        <label>Culto</label>
                        <select class="form-select" id="e_culto" required>
                            <option value="Domingo Manhã">Domingo Manhã</option>
                            <option value="Domingo Noite">Domingo Noite</option>
                            <option value="Terça">Terça (Doutrina/Oração)</option>
                            <option value="Quinta">Quinta (Vitória)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Data</label>
                        <input type="date" class="form-control" id="e_data" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Agendar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConselheiro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cadastrar Conselheiro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formConselheiro">
                    <div class="mb-3">
                        <label>Nome</label>
                        <input type="text" class="form-control" id="c_nome" required>
                    </div>
                    <div class="mb-3">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="c_telefone">
                    </div>
                    <button type="submit" class="btn btn-info text-white w-100">Salvar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURAÇÃO SUPABASE ---
    // ATENÇÃO: Estou usando o Ref extraído do seu token.
    const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE'; // *** INSIRA SUA CHAVE ANON AQUI ***
    
    // Obs: O usuário forneceu a chave no prompt, mas por segurança no código fonte 
    // eu deixei essa variável para você preencher. 
    // Cole a chave longa (começa com eyJ...) dentro das aspas acima.

    const supabase = showSection('dashboard') || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variável para armazenar dados localmente para filtragem rápida
    let allPessoas = [];

    // --- NAVEGAÇÃO ---
    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        
        // Atualiza dados ao entrar na aba
        if(sectionId === 'dashboard') loadDashboard();
        if(sectionId === 'pessoas') loadPessoas();
        if(sectionId === 'escalas') loadEscalas();
        if(sectionId === 'conselheiros') loadConselheiros();
    }

    // --- DASHBOARD ---
    async function loadDashboard() {
        const { data, error } = await supabase.from('pessoas').select('decisao, nome, created_at').order('created_at', {ascending: false});
        if(error) return console.error(error);

        // Contadores
        const counts = {
            'Aceitou Jesus': 0, 'Novo Nascimento': 0, 
            'Batismo Espírito Santo': 0, 'Volta para Jesus': 0
        };

        data.forEach(p => {
            if(counts[p.decisao] !== undefined) counts[p.decisao]++;
        });

        document.getElementById('count-jesus').innerText = counts['Aceitou Jesus'];
        document.getElementById('count-nascimento').innerText = counts['Novo Nascimento'];
        document.getElementById('count-batismo').innerText = counts['Batismo Espírito Santo'];
        document.getElementById('count-volta').innerText = counts['Volta para Jesus'];

        // Lista Recente (Top 5)
        const recentList = document.getElementById('recent-list');
        recentList.innerHTML = '';
        data.slice(0, 5).forEach(p => {
            recentList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${p.nome} <span class="badge bg-secondary rounded-pill">${p.decisao}</span>
            </li>`;
        });

        // Gráfico
        renderChart(counts);
    }

    let myChart = null;
    function renderChart(counts) {
        const ctx = document.getElementById('decisoesChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts),
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                }]
            }
        });
    }

    // --- PESSOAS ---
    async function loadPessoas() {
        // Busca pessoas e faz join com conselheiros
        const { data, error } = await supabase
            .from('pessoas')
            .select('*, conselheiros(nome)')
            .order('created_at', { ascending: false });

        if(error) return alert('Erro ao carregar pessoas');
        allPessoas = data;
        renderTabelaPessoas(data);
    }

    function renderTabelaPessoas(lista) {
        const tbody = document.getElementById('tabela-pessoas');
        tbody.innerHTML = '';
        lista.forEach(p => {
            const conselheiroNome = p.conselheiros ? p.conselheiros.nome : '-';
            const row = `<tr>
                <td><strong>${p.nome}</strong></td>
                <td>${p.telefone || ''}</td>
                <td>${p.endereco || ''}</td>
                <td><span class="badge bg-primary">${p.decisao}</span></td>
                <td>${conselheiroNome}</td>
                <td>${new Date(p.created_at).toLocaleDateString('pt-BR')}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function filtrarPessoas() {
        const termo = document.getElementById('filtro-nome').value.toLowerCase();
        const decisao = document.getElementById('filtro-decisao').value;

        const filtrados = allPessoas.filter(p => {
            const matchNome = p.nome.toLowerCase().includes(termo);
            const matchDecisao = decisao === "" || p.decisao === decisao;
            return matchNome && matchDecisao;
        });
        renderTabelaPessoas(filtrados);
    }

    // Cadastro de Pessoa
    document.getElementById('formPessoa').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nome = document.getElementById('p_nome').value;
        const telefone = document.getElementById('p_telefone').value;
        const endereco = document.getElementById('p_endereco').value;
        const decisao = document.getElementById('p_decisao').value;
        const conselheiro_id = document.getElementById('p_conselheiro').value || null;

        const { error } = await supabase.from('pessoas').insert({
            nome, telefone, endereco, decisao, conselheiro_id
        });

        if(error) alert('Erro ao salvar: ' + error.message);
        else {
            alert('Glória a Deus! Registro salvo.');
            document.getElementById('formPessoa').reset();
            bootstrap.Modal.getInstance(document.getElementById('modalPessoa')).hide();
            loadPessoas();
        }
    });

    // --- CONSELHEIROS ---
    async function loadConselheiros() {
        const { data, error } = await supabase.from('conselheiros').select('*').order('nome');
        if(error) return;
        const lista = document.getElementById('lista-conselheiros');
        lista.innerHTML = '';
        data.forEach(c => {
            lista.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <div><strong>${c.nome}</strong> <br> <small class="text-muted">${c.telefone || ''}</small></div>
                <i class="bi bi-check-circle-fill text-success"></i>
            </li>`;
        });
    }

    // Cadastro Conselheiro
    document.getElementById('formConselheiro').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nome = document.getElementById('c_nome').value;
        const telefone = document.getElementById('c_telefone').value;

        const { error } = await supabase.from('conselheiros').insert({ nome, telefone });
        if(error) alert('Erro: ' + error.message);
        else {
            alert('Conselheiro cadastrado!');
            document.getElementById('formConselheiro').reset();
            bootstrap.Modal.getInstance(document.getElementById('modalConselheiro')).hide();
            loadConselheiros();
        }
    });

    // Helpers para preencher selects
    async function carregarSelectConselheiros() {
        const { data } = await supabase.from('conselheiros').select('id, nome');
        const select = document.getElementById('p_conselheiro');
        select.innerHTML = '<option value="">Selecione...</option>';
        data.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        });
    }

    // --- ESCALAS ---
    async function loadEscalas() {
        const { data, error } = await supabase
            .from('escalas')
            .select('*, conselheiros(nome)')
            .gte('data_escala', new Date().toISOString().split('T')[0]) // Apenas datas futuras ou hoje
            .order('data_escala', { ascending: true });

        const container = document.getElementById('container-escalas');
        container.innerHTML = '';

        if(!data || data.length === 0) {
            container.innerHTML = '<p class="text-muted">Nenhuma escala futura agendada.</p>';
            return;
        }

        data.forEach(e => {
            const dataFmt = new Date(e.data_escala).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); // Ajuste fuso
            const card = `
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-primary fw-bold">${e.dia_culto}</h6>
                        <h3 class="card-title">${dataFmt}</h3>
                        <p class="card-text fs-5"><i class="bi bi-person-badge"></i> ${e.conselheiros.nome}</p>
                    </div>
                </div>
            </div>`;
            container.innerHTML += card;
        });
    }

    async function carregarSelectConselheirosEscala() {
        const { data } = await supabase.from('conselheiros').select('id, nome');
        const select = document.getElementById('e_conselheiro');
        select.innerHTML = '';
        data.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        });
    }

    // Cadastro Escala
    document.getElementById('formEscala').addEventListener('submit', async (e) => {
        e.preventDefault();
        const conselheiro_id = document.getElementById('e_conselheiro').value;
        const dia_culto = document.getElementById('e_culto').value;
        const data_escala = document.getElementById('e_data').value;

        const { error } = await supabase.from('escalas').insert({ conselheiro_id, dia_culto, data_escala });
        if(error) alert('Erro: ' + error.message);
        else {
            alert('Escala agendada!');
            document.getElementById('formEscala').reset();
            bootstrap.Modal.getInstance(document.getElementById('modalEscala')).hide();
            loadEscalas();
        }
    });

    // Inicialização correta do Supabase (Correção do objeto para funcionar sem import/export modules)
    // Sobrescrevendo a variável global com a instância correta
    const sbUrl = 'https://nekbbkenxcukoortusge.supabase.co';
    // *** COLOQUE SUA CHAVE AQUI NO LUGAR DE '...' ***
    const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc'; 
    
    window.supabase = window.supabase.createClient(sbUrl, sbKey);

    // Carregar Dashboard ao iniciar
    loadDashboard();

</script>

</body>

</html>
