<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Vidas & Escalas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
        .nav-link { color: rgba(255,255,255,0.8); cursor: pointer; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.2); border-radius: 5px; font-weight: bold; }
        .card-counter { box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 10px 0; padding: 20px; background-color: #fff; height: 120px; border-radius: 8px; position: relative; overflow: hidden; }
        .card-counter i { font-size: 4em; opacity: 0.1; position: absolute; right: 15px; top: 15px; }
        .count-numbers { font-size: 32px; font-weight: bold; display: block; }
        .count-name { opacity: 0.8; font-size: 14px; text-transform: uppercase; }
        
        .hidden { display: none !important; }
        
        /* Cores das Decisões */
        .border-jesus { border-left: 5px solid #0d6efd; color: #0d6efd; }
        .border-nascimento { border-left: 5px solid #198754; color: #198754; }
        .border-batismo { border-left: 5px solid #ffc107; color: #ffc107; }
        .border-volta { border-left: 5px solid #dc3545; color: #dc3545; }
        
        /* Loading overlay */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
            <h4 class="text-center mb-4 mt-2"><i class="bi bi-church"></i> Reino Manager</h4>
            <hr>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" onclick="app.navegar('dashboard')"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" onclick="app.navegar('pessoas')"><i class="bi bi-people me-2"></i> Pessoas</a></li>
                <li class="nav-item"><a class="nav-link" onclick="app.navegar('escalas')"><i class="bi bi-calendar-week me-2"></i> Escalas</a></li>
                <li class="nav-item"><a class="nav-link" onclick="app.navegar('conselheiros')"><i class="bi bi-person-badge me-2"></i> Conselheiros</a></li>
            </ul>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            
            <div class="d-md-none mb-3">
                <button class="btn btn-dark w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
                    <i class="bi bi-list"></i> Menu
                </button>
                <div class="collapse mt-2" id="mobileMenu">
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" onclick="app.navegar('dashboard')">Dashboard</a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="app.navegar('pessoas')">Pessoas</a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="app.navegar('escalas')">Escalas</a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="app.navegar('conselheiros')">Conselheiros</a>
                    </div>
                </div>
            </div>

            <div id="dashboard" class="section">
                <h2 class="mb-4">Visão Geral</h2>
                <div class="row text-center mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="card-counter border-jesus">
                            <i class="bi bi-heart-fill"></i>
                            <span class="count-numbers" id="count-jesus">0</span>
                            <span class="count-name">Aceitaram Jesus</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card-counter border-nascimento">
                            <i class="bi bi-droplet-fill"></i>
                            <span class="count-numbers" id="count-nascimento">0</span>
                            <span class="count-name">Novo Nascimento</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card-counter border-batismo">
                            <i class="bi bi-fire"></i>
                            <span class="count-numbers" id="count-batismo">0</span>
                            <span class="count-name">Batismo Esp. Santo</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card-counter border-volta">
                            <i class="bi bi-arrow-return-left"></i>
                            <span class="count-numbers" id="count-volta">0</span>
                            <span class="count-name">Volta p/ Jesus</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 p-3 shadow-sm border-0">
                            <h5 class="card-title">Distribuição de Decisões</h5>
                            <canvas id="decisoesChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 p-3 shadow-sm border-0">
                            <h5 class="card-title">Últimos Cadastros</h5>
                            <ul class="list-group list-group-flush" id="recent-list">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pessoas" class="section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Cadastro de Vidas</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPessoa" onclick="app.prepararModalPessoa()">
                        <i class="bi bi-plus-circle"></i> Nova Pessoa
                    </button>
                </div>

                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <input type="text" id="filtro-nome" class="form-control" placeholder="Buscar por nome..." onkeyup="app.filtrarPessoas()">
                            </div>
                            <div class="col-md-6">
                                <select id="filtro-decisao" class="form-select" onchange="app.filtrarPessoas()">
                                    <option value="">Todas as Decisões</option>
                                    <option value="Aceitou Jesus">Aceitou Jesus</option>
                                    <option value="Novo Nascimento">Novo Nascimento</option>
                                    <option value="Batismo Espírito Santo">Batismo Espírito Santo</option>
                                    <option value="Volta para Jesus">Volta para Jesus</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive bg-white rounded shadow-sm">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Contato / Endereço</th>
                                <th>Decisão</th>
                                <th>Conselheiro</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-pessoas">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="escalas" class="section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Escalas de Culto</h2>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalEscala" onclick="app.prepararModalEscala()">
                        <i class="bi bi-calendar-plus"></i> Nova Escala
                    </button>
                </div>

                <div class="row" id="container-escalas">
                    </div>
            </div>

            <div id="conselheiros" class="section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Conselheiros</h2>
                    <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#modalConselheiro">
                        <i class="bi bi-person-plus"></i> Novo Conselheiro
                    </button>
                </div>
                <ul class="list-group shadow-sm" id="lista-conselheiros">
                    </ul>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalPessoa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Registrar Decisão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formPessoa" onsubmit="app.salvarPessoa(event)">
                    <div class="mb-3">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" id="p_nome" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="p_telefone" placeholder="(XX) 9XXXX-XXXX">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Endereço</label>
                        <input type="text" class="form-control" id="p_endereco">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Decisão *</label>
                        <select class="form-select" id="p_decisao" required>
                            <option value="Aceitou Jesus">Aceitou Jesus</option>
                            <option value="Volta para Jesus">Volta para Jesus</option>
                            <option value="Novo Nascimento">Novo Nascimento</option>
                            <option value="Batismo Espírito Santo">Batismo Espírito Santo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conselheiro Responsável</label>
                        <select class="form-select" id="p_conselheiro">
                            <option value="">Selecione...</option>
                            </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Salvar Registro</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEscala" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Agendar Escala</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEscala" onsubmit="app.salvarEscala(event)">
                    <div class="mb-3">
                        <label class="form-label">Conselheiro *</label>
                        <select class="form-select" id="e_conselheiro" required>
                            </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Culto *</label>
                        <select class="form-select" id="e_culto" required>
                            <option value="Domingo Manhã">Domingo Manhã</option>
                            <option value="Domingo Noite">Domingo Noite</option>
                            <option value="Terça">Terça (Doutrina/Oração)</option>
                            <option value="Quinta">Quinta (Vitória)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data *</label>
                        <input type="date" class="form-control" id="e_data" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Agendar Escala</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConselheiro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Cadastrar Conselheiro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formConselheiro" onsubmit="app.salvarConselheiro(event)">
                    <div class="mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="c_nome" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="c_telefone">
                    </div>
                    <button type="submit" class="btn btn-info text-white w-100">Salvar Conselheiro</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. Configuração do Banco de Dados
    const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
    
    // Inicializa o cliente Supabase globalmente
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Objeto principal da Aplicação (Evita conflitos globais)
    const app = {
        allPessoas: [],
        chartInstance: null,

        // Inicialização
        init: function() {
            this.navegar('dashboard');
            document.getElementById('loading').style.display = 'none';
        },

        // Navegação
        navegar: function(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Menu Ativo
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // Tenta encontrar o link correspondente e ativar (opcional)

            // Carrega dados
            if(sectionId === 'dashboard') this.loadDashboard();
            if(sectionId === 'pessoas') this.loadPessoas();
            if(sectionId === 'escalas') this.loadEscalas();
            if(sectionId === 'conselheiros') this.loadConselheiros();
        },

        // --- DASHBOARD ---
        loadDashboard: async function() {
            const { data, error } = await _supabase.from('pessoas').select('decisao, nome, created_at').order('created_at', {ascending: false});
            if(error) { console.error(error); return; }

            const counts = { 'Aceitou Jesus': 0, 'Novo Nascimento': 0, 'Batismo Espírito Santo': 0, 'Volta para Jesus': 0 };
            data.forEach(p => { if(counts[p.decisao] !== undefined) counts[p.decisao]++; });

            document.getElementById('count-jesus').innerText = counts['Aceitou Jesus'];
            document.getElementById('count-nascimento').innerText = counts['Novo Nascimento'];
            document.getElementById('count-batismo').innerText = counts['Batismo Espírito Santo'];
            document.getElementById('count-volta').innerText = counts['Volta para Jesus'];

            // Lista Recente
            const recentList = document.getElementById('recent-list');
            recentList.innerHTML = '';
            data.slice(0, 5).forEach(p => {
                recentList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${p.nome} <span class="badge bg-secondary rounded-pill">${p.decisao}</span>
                </li>`;
            });

            this.renderChart(counts);
        },

        renderChart: function(counts) {
            const ctx = document.getElementById('decisoesChart').getContext('2d');
            if(this.chartInstance) this.chartInstance.destroy();
            this.chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545']
                    }]
                }
            });
        },

        // --- PESSOAS ---
        loadPessoas: async function() {
            const { data, error } = await _supabase.from('pessoas').select('*, conselheiros(nome)').order('created_at', { ascending: false });
            if(error) return alert('Erro ao carregar lista.');
            
            this.allPessoas = data;
            this.renderTabelaPessoas(data);
        },

        renderTabelaPessoas: function(lista) {
            const tbody = document.getElementById('tabela-pessoas');
            tbody.innerHTML = '';
            if(lista.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="text-center p-3">Nenhum registro encontrado.</td></tr>';
            
            lista.forEach(p => {
                const conselheiro = p.conselheiros ? p.conselheiros.nome : '<span class="text-muted fst-italic">Não informado</span>';
                const row = `<tr>
                    <td><strong>${p.nome}</strong></td>
                    <td>
                        <div><i class="bi bi-telephone"></i> ${p.telefone || '-'}</div>
                        <div class="small text-muted"><i class="bi bi-geo-alt"></i> ${p.endereco || '-'}</div>
                    </td>
                    <td><span class="badge bg-primary">${p.decisao}</span></td>
                    <td>${conselheiro}</td>
                    <td>${new Date(p.created_at).toLocaleDateString('pt-BR')}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        },

        filtrarPessoas: function() {
            const termo = document.getElementById('filtro-nome').value.toLowerCase();
            const decisao = document.getElementById('filtro-decisao').value;

            const filtrados = this.allPessoas.filter(p => {
                const matchNome = p.nome.toLowerCase().includes(termo);
                const matchDecisao = decisao === "" || p.decisao === decisao;
                return matchNome && matchDecisao;
            });
            this.renderTabelaPessoas(filtrados);
        },

        prepararModalPessoa: async function() {
            const { data } = await _supabase.from('conselheiros').select('id, nome').order('nome');
            const select = document.getElementById('p_conselheiro');
            select.innerHTML = '<option value="">Selecione...</option>';
            data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
        },

        salvarPessoa: async function(e) {
            e.preventDefault();
            const payload = {
                nome: document.getElementById('p_nome').value,
                telefone: document.getElementById('p_telefone').value,
                endereco: document.getElementById('p_endereco').value,
                decisao: document.getElementById('p_decisao').value,
                conselheiro_id: document.getElementById('p_conselheiro').value || null
            };

            const { error } = await _supabase.from('pessoas').insert(payload);
            if(error) alert('Erro: ' + error.message);
            else {
                alert('Salvo com sucesso!');
                document.getElementById('formPessoa').reset();
                bootstrap.Modal.getInstance(document.getElementById('modalPessoa')).hide();
                this.loadPessoas();
            }
        },

        // --- ESCALAS ---
        loadEscalas: async function() {
            const hoje = new Date().toISOString().split('T')[0];
            const { data, error } = await _supabase
                .from('escalas')
                .select('*, conselheiros(nome)')
                .gte('data_escala', hoje)
                .order('data_escala', { ascending: true });

            const container = document.getElementById('container-escalas');
            container.innerHTML = '';

            if(!data || data.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted mt-4"><h5>Nenhuma escala futura agendada.</h5></div>';
                return;
            }

            data.forEach(e => {
                // Ajuste visual da data
                const dateParts = e.data_escala.split('-'); 
                const dataDisplay = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; // DD/MM/YYYY

                const card = `
                <div class="col-md-4 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h6 class="text-primary fw-bold text-uppercase">${e.dia_culto}</h6>
                            <h2 class="display-6 my-3">${dataDisplay}</h2>
                            <hr>
                            <p class="card-text fs-5"><i class="bi bi-person-badge-fill text-secondary"></i> ${e.conselheiros.nome}</p>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        },

        prepararModalEscala: async function() {
            const { data } = await _supabase.from('conselheiros').select('id, nome').order('nome');
            const select = document.getElementById('e_conselheiro');
            select.innerHTML = '<option value="">Selecione...</option>';
            data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
        },

        salvarEscala: async function(e) {
            e.preventDefault();
            const payload = {
                conselheiro_id: document.getElementById('e_conselheiro').value,
                dia_culto: document.getElementById('e_culto').value,
                data_escala: document.getElementById('e_data').value
            };
            
            const { error } = await _supabase.from('escalas').insert(payload);
            if(error) alert('Erro: ' + error.message);
            else {
                alert('Escala agendada!');
                document.getElementById('formEscala').reset();
                bootstrap.Modal.getInstance(document.getElementById('modalEscala')).hide();
                this.loadEscalas();
            }
        },

        // --- CONSELHEIROS ---
        loadConselheiros: async function() {
            const { data, error } = await _supabase.from('conselheiros').select('*').order('nome');
            const lista = document.getElementById('lista-conselheiros');
            lista.innerHTML = '';
            
            if(!data) return;

            data.forEach(c => {
                lista.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center p-3">
                    <div>
                        <strong class="fs-5">${c.nome}</strong> 
                        <br> <small class="text-muted"><i class="bi bi-whatsapp"></i> ${c.telefone || 'Não informado'}</small>
                    </div>
                    <i class="bi bi-check-circle-fill text-success fs-4"></i>
                </li>`;
            });
        },

        salvarConselheiro: async function(e) {
            e.preventDefault();
            const payload = {
                nome: document.getElementById('c_nome').value,
                telefone: document.getElementById('c_telefone').value
            };

            const { error } = await _supabase.from('conselheiros').insert(payload);
            if(error) alert('Erro: ' + error.message);
            else {
                alert('Conselheiro cadastrado!');
                document.getElementById('formConselheiro').reset();
                bootstrap.Modal.getInstance(document.getElementById('modalConselheiro')).hide();
                this.loadConselheiros();
            }
        }
    };

    // Iniciar app quando a página carregar
    document.addEventListener('DOMContentLoaded', () => {
        app.init();
    });

</script>

</body>
</html>
