<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Ministry Manager - Escala2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        .active-tab { background-color: #3b82f6; color: white; }
        .hidden-section { display: none; }
        body { background-color: #f3f4f6; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <aside class="w-full md:w-64 bg-white shadow-lg flex-shrink-0 flex flex-col z-20">
        <div class="p-6 bg-blue-600 text-white flex items-center justify-between">
            <h1 class="text-xl font-bold"><i class="fas fa-child"></i> Depto. Infantil</h1>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-2 px-4">
                <li><button onclick="showSection('dashboard')" id="btn-dashboard" class="w-full text-left py-2 px-4 rounded hover:bg-blue-100 transition active-tab"><i class="fas fa-chart-pie mr-2"></i> Dashboard</button></li>
                <li><button onclick="showSection('checkin')" id="btn-checkin" class="w-full text-left py-2 px-4 rounded hover:bg-blue-100 transition"><i class="fas fa-qrcode mr-2"></i> Check-in / Saída</button></li>
                <li><button onclick="showSection('professores')" id="btn-professores" class="w-full text-left py-2 px-4 rounded hover:bg-blue-100 transition"><i class="fas fa-users mr-2"></i> Professores</button></li>
                <li><button onclick="showSection('escala')" id="btn-escala" class="w-full text-left py-2 px-4 rounded hover:bg-blue-100 transition"><i class="fas fa-calendar-alt mr-2"></i> Escala (v2)</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t text-xs text-gray-500 text-center">
            Sistema V 2.1 (Simples)
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 relative">
        
        <section id="dashboard" class="block">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Visão Geral</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                    <p class="text-gray-500 text-sm">Crianças Presentes Agora</p>
                    <p class="text-3xl font-bold" id="dash-total-kids">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm">Professores na Escala (Hoje)</p>
                    <p class="text-3xl font-bold" id="dash-total-teachers">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-purple-500">
                    <p class="text-gray-500 text-sm">Sala Mais Cheia</p>
                    <p class="text-xl font-bold truncate" id="dash-busy-room">-</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="font-bold mb-4">Crianças por Sala (Hoje)</h3>
                    <canvas id="kidsChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="font-bold mb-4">Últimas Movimentações</h3>
                    <ul id="recent-activity" class="text-sm space-y-2">
                        <li class="text-gray-500">Carregando...</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="checkin" class="hidden-section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Registro de Presença (QR Code)</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="font-bold mb-2">Escanear QR Code</h3>
                    <div id="reader" class="w-full bg-black h-64 rounded mb-4"></div>
                    <p class="text-sm text-gray-500 mb-2">Aponte para o QR fixo da criança.</p>
                    <div id="scan-result" class="hidden p-3 bg-yellow-100 text-yellow-800 rounded mb-2 font-mono text-center"></div>
                    
                    <div id="entry-form" class="hidden mt-4 border-t pt-4">
                        <h4 class="font-bold text-blue-600 mb-2">Novo Check-in</h4>
                        <input type="text" id="entry-qr" class="hidden"> <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" id="entry-name" placeholder="Nome da Criança" class="border p-2 rounded w-full">
                            <input type="number" id="entry-age" placeholder="Idade" class="border p-2 rounded w-full" onchange="autoSelectRoom()">
                        </div>
                        <input type="text" id="entry-parent" placeholder="Nome do Responsável" class="border p-2 rounded w-full mb-2">
                        <select id="entry-room" class="border p-2 rounded w-full mb-3 bg-gray-100">
                            <option value="">Selecione a Sala (Auto)</option>
                            <option value="0-2">Sala 0 a 2 anos</option>
                            <option value="3-5">Sala 3 a 5 anos</option>
                            <option value="6-8">Sala 6 a 8 anos</option>
                            <option value="9-12">Sala 9 a 12 anos</option>
                        </select>
                        <button onclick="confirmCheckIn()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded">Confirmar Entrada</button>
                    </div>

                    <div id="exit-msg" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                        <strong class="font-bold">Saída Registrada!</strong>
                        <span class="block sm:inline" id="exit-details"></span>
                    </div>
                </div>

                <div class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold">Crianças em Sala (Agora)</h3>
                        <button onclick="loadActiveKids()" class="text-blue-500 text-sm"><i class="fas fa-sync"></i></button>
                    </div>
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-2">Nome</th>
                                <th class="p-2">Sala</th>
                                <th class="p-2">Entrada</th>
                            </tr>
                        </thead>
                        <tbody id="active-kids-list">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="professores" class="hidden-section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Gerenciamento de Professores</h2>
            
            <div class="bg-white p-4 rounded shadow mb-6">
                <h3 class="font-bold mb-2">Cadastrar Novo</h3>
                <div class="flex flex-wrap gap-2">
                    <input type="text" id="prof-name" placeholder="Nome Completo" class="border p-2 rounded flex-1">
                    <select id="prof-sala" class="border p-2 rounded w-40">
                        <option value="0-2">0 a 2 anos</option>
                        <option value="3-5">3 a 5 anos</option>
                        <option value="6-8">6 a 8 anos</option>
                        <option value="9-12">9 a 12 anos</option>
                    </select>
                    <input type="text" id="prof-tel" placeholder="Telefone" class="border p-2 rounded w-40">
                    <button onclick="addTeacher()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Salvar</button>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sala Pref.</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="teachers-list">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="escala" class="hidden-section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Escala do Culto (Escala2)</h2>
            
            <div class="bg-white p-6 rounded shadow mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Data do Culto</label>
                        <input type="date" id="escala-date" class="border p-2 rounded w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Sala</label>
                        <select id="escala-sala" class="border p-2 rounded w-full" onchange="filterTeachersForEscala()">
                            <option value="0-2">0 a 2 anos</option>
                            <option value="3-5">3 a 5 anos</option>
                            <option value="6-8">6 a 8 anos</option>
                            <option value="9-12">9 a 12 anos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Professores Disponíveis</label>
                        <select id="escala-prof-select" class="border p-2 rounded w-full h-10" multiple>
                            </select>
                        <p class="text-xs text-gray-500 mt-1">* Segure Ctrl/Cmd para selecionar vários</p>
                    </div>
                </div>
                <button onclick="saveEscala()" class="w-full bg-purple-600 text-white font-bold py-2 rounded hover:bg-purple-700">Salvar na Escala2</button>
            </div>

            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold mb-4">Escala Atual (Próximos Cultos)</h3>
                <div id="escala-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </section>

    </main>

    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Editar Professor</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="hidden" id="edit-id">
                    <input type="text" id="edit-name" class="mb-3 border p-2 w-full rounded" placeholder="Nome">
                    <select id="edit-sala" class="mb-3 border p-2 w-full rounded">
                        <option value="0-2">0-2</option><option value="3-5">3-5</option><option value="6-8">6-8</option><option value="9-12">9-12</option>
                    </select>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="updateTeacher()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Salvar
                    </button>
                    <button onclick="document.getElementById('editModal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 text-black text-base font-medium rounded shadow-sm hover:bg-gray-400">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc'; 

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- NAVEGAÇÃO ---
        function showSection(id) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab'));
            document.getElementById('btn-' + id).classList.add('active-tab');

            if(id === 'professores') loadTeachers();
            if(id === 'escala') loadTeachersForEscala();
            if(id === 'dashboard') loadDashboard();
            if(id === 'checkin') startScanner();
            else stopScanner();
        }

        // --- PROFESSORES (CRUD) ---
        async function loadTeachers() {
            const { data, error } = await supabase.from('professores').select('*').order('nome');
            const list = document.getElementById('teachers-list');
            list.innerHTML = '';
            
            if(data) {
                data.forEach(p => {
                    const row = `
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${p.nome}</p></td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight"><span aria-hidden class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span><span class="relative">${p.sala_preferencia}</span></span></td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <button onclick="openEditTeacher('${p.id}', '${p.nome}', '${p.sala_preferencia}')" class="text-blue-600 hover:text-blue-900 mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteTeacher('${p.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    list.innerHTML += row;
                });
            }
        }

        async function addTeacher() {
            const nome = document.getElementById('prof-name').value;
            const sala = document.getElementById('prof-sala').value;
            const tel = document.getElementById('prof-tel').value;

            if(!nome) return alert("Preencha o nome");

            // SIMPLIFICAÇÃO: Enviando apenas os campos de dados. O ID é gerado pelo banco.
            const novoProfessor = {
                nome: nome,
                sala_preferencia: sala,
                telefone: tel
            };

            const { error } = await supabase.from('professores').insert([novoProfessor]);
            
            if(error) {
                console.error(error);
                alert('Erro ao salvar. Verifique se o banco está configurado para gerar IDs automaticamente.');
            } else {
                document.getElementById('prof-name').value = '';
                loadTeachers();
            }
        }

        async function deleteTeacher(id) {
            if(confirm('Tem certeza?')) {
                await supabase.from('professores').delete().eq('id', id);
                loadTeachers();
            }
        }

        function openEditTeacher(id, nome, sala) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = nome;
            document.getElementById('edit-sala').value = sala;
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function updateTeacher() {
            const id = document.getElementById('edit-id').value;
            const nome = document.getElementById('edit-name').value;
            const sala = document.getElementById('edit-sala').value;

            await supabase.from('professores').update({ nome, sala_preferencia: sala }).eq('id', id);
            document.getElementById('editModal').classList.add('hidden');
            loadTeachers();
        }

        // --- ESCALA (USANDO TABELA Escala2) ---
        async function loadTeachersForEscala() {
            const { data } = await supabase.from('professores').select('*');
            window.allTeachers = data || []; 
            filterTeachersForEscala();
            loadEscalas();
        }

        function filterTeachersForEscala() {
            const sala = document.getElementById('escala-sala').value;
            const select = document.getElementById('escala-prof-select');
            select.innerHTML = '';
            
            if(window.allTeachers) {
                const filtered = window.allTeachers.filter(t => t.sala_preferencia === sala);
                filtered.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id; // Guarda ID do professor para relação
                    opt.text = t.nome;
                    select.appendChild(opt);
                });
            }
        }

        async function saveEscala() {
            const dataCulto = document.getElementById('escala-date').value;
            const sala = document.getElementById('escala-sala').value;
            const select = document.getElementById('escala-prof-select');
            const selectedOpts = Array.from(select.selectedOptions).map(opt => opt.value);

            if(!dataCulto || selectedOpts.length === 0) return alert("Preencha a data e escolha professores");

            // SIMPLIFICAÇÃO: Criação limpa do objeto de inserção
            const inserts = selectedOpts.map(pid => {
                return {
                    data_culto: dataCulto,
                    sala: sala,
                    professor_id: pid // Usa o ID vindo do select. Certifique-se que é o tipo correto.
                };
            });

            const { error } = await supabase.from('Escala2').insert(inserts);
            
            if(error) {
                console.error(error);
                alert("Erro ao escalar: " + error.message);
            } else {
                alert("Escala salva!");
                loadEscalas();
            }
        }

        async function loadEscalas() {
            const { data } = await supabase.from('Escala2')
                .select('*, professores(nome)')
                .order('data_culto', { ascending: true });
            
            const container = document.getElementById('escala-list');
            container.innerHTML = '';

            if(data) {
                const grouped = {};
                data.forEach(item => {
                    const key = `${item.data_culto} - Sala ${item.sala}`;
                    if(!grouped[key]) grouped[key] = [];
                    // Tratamento seguro para caso o professor tenha sido deletado
                    if (item.professores && item.professores.nome) {
                        grouped[key].push(item.professores.nome);
                    } else {
                        grouped[key].push("(Prof. Removido)");
                    }
                });

                for (const [key, profs] of Object.entries(grouped)) {
                    container.innerHTML += `
                        <div class="border p-3 rounded bg-gray-50">
                            <h4 class="font-bold text-blue-600">${key}</h4>
                            <p class="text-sm text-gray-700 mt-1">${profs.join(', ')}</p>
                        </div>
                    `;
                }
            }
        }

        // --- CHECK-IN / QR CODE ---
        let html5QrcodeScanner = null;

        function startScanner() {
            if(html5QrcodeScanner) return; 

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                 console.log("Erro câmera traseira, tentando padrão", err);
            });
            
            document.getElementById('escala-date').valueAsDate = new Date();
            loadActiveKids();
        }

        function stopScanner() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.log(err));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('scan-result').innerText = `QR Lido: ${decodedText}`;
            document.getElementById('scan-result').classList.remove('hidden');

            // Busca sessão aberta usando o QR
            const { data: activeSession } = await supabase
                .from('frequencia')
                .select('*')
                .eq('qr_id', decodedText)
                .is('hora_saida', null) 
                .single();

            if (activeSession) {
                // CHECK-OUT
                const { error } = await supabase
                    .from('frequencia')
                    .update({ hora_saida: new Date().toISOString(), status: 'finalizado' })
                    .eq('id', activeSession.id); // Aqui precisamos do ID da linha para atualizar, isso é normal
                
                if(!error) {
                    document.getElementById('entry-form').classList.add('hidden');
                    document.getElementById('exit-msg').classList.remove('hidden');
                    document.getElementById('exit-details').innerText = `${activeSession.nome_crianca} saiu da sala ${activeSession.sala}.`;
                    loadActiveKids();
                    setTimeout(() => { document.getElementById('exit-msg').classList.add('hidden'); }, 5000);
                }
            } else {
                // CHECK-IN (Preparação)
                document.getElementById('exit-msg').classList.add('hidden');
                document.getElementById('entry-form').classList.remove('hidden');
                document.getElementById('entry-qr').value = decodedText;
                
                // Tenta preencher dados anteriores
                const { data: lastRecord } = await supabase
                    .from('frequencia')
                    .select('*')
                    .eq('qr_id', decodedText)
                    .order('hora_entrada', { ascending: false })
                    .limit(1)
                    .single();
                
                if(lastRecord) {
                    document.getElementById('entry-name').value = lastRecord.nome_crianca;
                    document.getElementById('entry-age').value = lastRecord.idade;
                    document.getElementById('entry-parent').value = lastRecord.responsavel_nome;
                    autoSelectRoom();
                } else {
                    document.getElementById('entry-name').value = '';
                    document.getElementById('entry-age').value = '';
                }
            }
        }

        function autoSelectRoom() {
            const age = parseInt(document.getElementById('entry-age').value);
            const select = document.getElementById('entry-room');
            if(isNaN(age)) return;

            if (age <= 2) select.value = "0-2";
            else if (age <= 5) select.value = "3-5";
            else if (age <= 8) select.value = "6-8";
            else if (age <= 12) select.value = "9-12";
        }

        async function confirmCheckIn() {
            const qr = document.getElementById('entry-qr').value;
            const nome = document.getElementById('entry-name').value;
            const idade = document.getElementById('entry-age').value;
            const sala = document.getElementById('entry-room').value;
            const resp = document.getElementById('entry-parent').value;

            if(!nome || !sala) return alert("Preencha os dados");

            // SIMPLIFICAÇÃO: Objeto limpo para inserção.
            // Certifique-se que a coluna 'id' no banco é Identity (auto-increment)
            const registroEntrada = {
                qr_id: qr,
                nome_crianca: nome,
                idade: parseInt(idade), // Força número inteiro
                sala: sala,
                responsavel_nome: resp,
                data_culto: new Date().toISOString().split('T')[0]
            };

            const { error } = await supabase.from('frequencia').insert([registroEntrada]);

            if(error) {
                console.error(error);
                alert("Erro ao registrar entrada. Verifique o console.");
            } else {
                document.getElementById('entry-form').classList.add('hidden');
                alert("Entrada Registrada!");
                loadActiveKids();
            }
        }

        async function loadActiveKids() {
            const { data } = await supabase
                .from('frequencia')
                .select('*')
                .is('hora_saida', null)
                .order('hora_entrada', { ascending: false });
            
            const tbody = document.getElementById('active-kids-list');
            tbody.innerHTML = '';
            
            if(data) {
                data.forEach(k => {
                    const hora = new Date(k.hora_entrada).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-2 font-bold">${k.nome_crianca} <span class="text-xs text-gray-400">(${k.idade}a)</span></td>
                            <td class="p-2"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">${k.sala}</span></td>
                            <td class="p-2 text-xs text-gray-500">${hora}</td>
                        </tr>
                    `;
                });
            }
        }

        // --- DASHBOARD ANALYTICS ---
        async function loadDashboard() {
            const { count: kidsCount } = await supabase.from('frequencia').select('*', { count: 'exact' }).is('hora_saida', null);
            document.getElementById('dash-total-kids').innerText = kidsCount || 0;

            const today = new Date().toISOString().split('T')[0];
            const { count: profCount } = await supabase.from('Escala2').select('*', { count: 'exact' }).eq('data_culto', today);
            document.getElementById('dash-total-teachers').innerText = profCount || 0;

            const { data: kidsData } = await supabase.from('frequencia').select('sala').is('hora_saida', null);
            
            const counts = { '0-2': 0, '3-5': 0, '6-8': 0, '9-12': 0 };
            if(kidsData) {
                kidsData.forEach(k => { if(counts[k.sala] !== undefined) counts[k.sala]++; });
            }

            let maxRoom = '-';
            let maxVal = 0;
            for(const [room, val] of Object.entries(counts)) {
                if(val > maxVal) { maxVal = val; maxRoom = room; }
            }
            document.getElementById('dash-busy-room').innerText = maxRoom;

            const ctx = document.getElementById('kidsChart').getContext('2d');
            if(window.myChart) window.myChart.destroy(); 
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-2 Anos', '3-5 Anos', '6-8 Anos', '9-12 Anos'],
                    datasets: [{
                        label: 'Crianças Presentes',
                        data: [counts['0-2'], counts['3-5'], counts['6-8'], counts['9-12']],
                        backgroundColor: ['#60a5fa', '#34d399', '#f472b6', '#a78bfa']
                    }]
                }
            });

            const { data: logs } = await supabase.from('frequencia').select('nome_crianca, status, hora_entrada, hora_saida').order('hora_entrada', {ascending: false}).limit(5);
            const logContainer = document.getElementById('recent-activity');
            logContainer.innerHTML = '';
            if(logs) {
                logs.forEach(l => {
                    const action = l.status === 'presente' ? 'Entrou' : 'Saiu';
                    const time = l.status === 'presente' ? new Date(l.hora_entrada).toLocaleTimeString() : new Date(l.hora_saida).toLocaleTimeString();
                    const color = l.status === 'presente' ? 'text-green-600' : 'text-red-600';
                    logContainer.innerHTML += `<li class="flex justify-between border-b pb-1"><span>${l.nome_crianca}</span> <span class="${color} font-bold text-xs">${action} às ${time}</span></li>`;
                });
            }
        }

        // Inicializar Dashboard ao abrir
        showSection('dashboard');

    </script>
</body>
</html>
